#!/usr/bin/env nu

{{ if eq .chezmoi.osRelease.id "opensuse-tumbleweed" "opensuse-leap" "opensuse" -}}

sudo zypper addrepo --refresh https://download.opensuse.org/repositories/home:kaiman/openSUSE_Tumbleweed/home:kaiman.repo home:kaiman
sudo zypper addrepo --refresh https://download.opensuse.org/repositories/home:mantarimay:sway/openSUSE_Tumbleweed/home:mantarimay:sway.repo home:mantarimay:sway
sudo zypper refresh home:kaiman home:mantarimay:sway

let zypper_packages = [
    # compositor
    mangowc
    # brightness
    brightnessctl
    # screen locker
    swaylock-effects
    # editors
    helix emacs
    # terminal
    foot
    # bar / notifications / idle
    waybar mako hypridle
    # clipboard
    cliphist wl-clipboard
    # shell
    nushell
    # launcher
    rofi
    # file managers / viewers
    yazi broot feh
    zathura zathura-plugin-pdf-poppler
    # audio
    pipewire pipewire-pulseaudio wireplumber
    # music
    mpd
    # email
    isync notmuch
    # browser
    qutebrowser
    # matrix
    iamb
    # wallpaper
    swww
    # toolchains
    uv go
    # bluetooth
    bluez
]

sudo zypper --non-interactive install ...$zypper_packages

{{ else if eq .chezmoi.osRelease.id "fedora" -}}

let dnf_packages = [
    # editors
    helix emacs
    # terminal
    foot
    # bar / notifications / idle
    waybar mako hypridle
    # clipboard
    cliphist wl-clipboard
    # shell
    nushell
    # file managers / viewers
    yazi broot feh
    zathura zathura-plugins-all
    # audio
    pipewire pipewire-pulseaudio wireplumber
    # music
    mpd
    # email
    isync notmuch
    # browser
    qutebrowser
    # matrix
    iamb
    # toolchains
    uv golang
]

sudo dnf install -y ...$dnf_packages

{{ else -}}
error make {msg: $"Unsupported distro: {{ .chezmoi.osRelease.id }}"}
{{ end -}}

# ── cargo installs ────────────────────────────────────────────────────────────

let cargo_tools = [
    {cmd: "wl-clip-persist", args: ["wl-clip-persist"]}
    {cmd: "kanata",          args: ["kanata"]}
    {cmd: "wiremix",         args: ["wiremix"]}
    {cmd: "aparte",          args: ["aparte"]}
    {cmd: "rmpc",            args: ["--git", "https://github.com/mierak/rmpc"]}
]

$cargo_tools
    | where {|tool| (which $tool.cmd | is-empty)}
    | each {|tool| ^cargo install ...$tool.args}

# ── uv tool installs ──────────────────────────────────────────────────────────

uv tool install alot

# ── go installs ───────────────────────────────────────────────────────────────
let go_tools = [                                                                                   
    {cmd: "pomo", args: ["codeberg.org/kevinschoon/pomo/cmd/pomo@latest"]}                         
    {cmd: "ghq",  args: ["github.com/x-motemen/ghq@latest"]}
]                                                                                                  
                                                                                             
$go_tools                                                                                          
    | where {|tool| (which $tool.cmd | is-empty)}
    | each {|tool| ^go install ...$tool.args}
# ── heads up ──────────────────────────────────────────────────────────────────

print ""
print "NOTE: swww is installed but your configs reference 'awww-daemon'."
print "      The swww binary is 'swww-daemon' — update your systemd service and awww-daemon.service if needed."
print ""
