#!/usr/bin/env nu

{{ if eq .chezmoi.osRelease.id "opensuse-tumbleweed" "opensuse-leap" "opensuse" -}}

{{ range .packages.opensuse.zypper -}}
{{ if .repo -}}
sudo zypper addrepo --refresh "{{ .repo }}"
sudo zypper refresh
{{ end -}}
sudo zypper --non-interactive install{{ range .packages }} "{{ . }}"{{ end }}

{{ end -}}

{{ else if eq .chezmoi.osRelease.id "fedora" -}}

let dnf_packages = [
    {{- range .packages.fedora.dnf }}
    "{{ . }}"
    {{- end }}
]

sudo dnf install -y ...$dnf_packages

{{ else -}}
error make {msg: $"Unsupported distro: {{ .chezmoi.osRelease.id }}"}
{{ end -}}

# ── cargo installs ────────────────────────────────────────────────────────────

let cargo_tools = [
    {{- range .packages.cargo }}
    {{- if (index . "in-args") }}
    {cmd: "{{ .cmd }}", "in-args": {{ index . "in-args" | toJson }}}
    {{- else }}
    {cmd: "{{ .cmd }}"}
    {{- end }}
    {{- end }}
]

$cargo_tools
    | where {|tool| (which $tool.cmd | is-empty)}
    | each {|tool|
        if ($tool."in-args"? | is-empty) {
            ^cargo install $tool.cmd
        } else {
            ^cargo install ...$tool."in-args"
        }
    }

# ── uv tool installs ──────────────────────────────────────────────────────────

{{ range .packages.uv -}}
uv tool install {{ . }}
{{ end -}}

# ── go installs ───────────────────────────────────────────────────────────────

let go_tools = [
    {{- range .packages.go }}
    {cmd: "{{ .cmd }}", args: {{ .args | toJson }}}
    {{- end }}
]

$go_tools
    | where {|tool| (which $tool.cmd | is-empty)}
    | each {|tool| ^go install ...$tool.args}

# ── heads up ──────────────────────────────────────────────────────────────────

print ""
print "NOTE: swww is installed but your configs reference 'awww-daemon'."
print "      The swww binary is 'swww-daemon' — update your systemd service and awww-daemon.service if needed."
print ""
print "NOTE: binds_float.conf launches 'pomodoro' (rust-cli-pomodoro) which you removed — update that bind to use 'pomo'."
