#!/usr/bin/env nu

{{ if eq .chezmoi.osRelease.id "opensuse-tumbleweed" "opensuse-leap" "opensuse" -}}

{{ range .opensuse.zypper -}}
{{ if .repo -}}
try { sudo zypper addrepo --refresh "{{ .repo }}" }
sudo zypper refresh
{{ end -}}
let pkg_checks = [
    {{- range .packages }}
    {{- if kindIs "string" . }}
    {pkg: "{{ . }}", check: "rpm"}
    {{- else }}
    {pkg: "{{ .name }}", check: "which", bin: "{{ .which }}"}
    {{- end }}
    {{- end }}
]
let missing = ($pkg_checks
    | where {|p|
        if $p.check == "rpm" {
            (^rpm -q $p.pkg | complete).exit_code != 0
        } else {
            (which $p.bin | is-empty)
        }
    }
    | get pkg)
if ($missing | is-not-empty) {
    sudo zypper --non-interactive install ...$missing
}

{{ end -}}

{{ else if eq .chezmoi.osRelease.id "fedora" "fedora-asahi-remix" -}}

let pkg_checks = [
    {{- range .fedora.dnf }}
    {{- if kindIs "string" . }}
    {pkg: "{{ . }}", check: "rpm"}
    {{- else }}
    {pkg: "{{ .name }}", check: "which", bin: "{{ .which }}"}
    {{- end }}
    {{- end }}
]
let missing = ($pkg_checks
    | where {|p|
        if $p.check == "rpm" {
            (^rpm -q $p.pkg | complete).exit_code != 0
        } else {
            (which $p.bin | is-empty)
        }
    }
    | get pkg)
if ($missing | is-not-empty) {
    sudo dnf install -y --skip-unavailable --skip-broken ...$missing
}

{{ else -}}
error make {msg: $"Unsupported distro: {{ .chezmoi.osRelease.id }}"}
{{ end -}}

# ── cargo installs ────────────────────────────────────────────────────────────

let cargo_tools = [
    {{- range .cargo }}
    {{- if (index . "in-args") }}
    {cmd: "{{ .cmd }}", "in-args": {{ index . "in-args" | toJson }}}
    {{- else }}
    {cmd: "{{ .cmd }}"}
    {{- end }}
    {{- end }}
]

$cargo_tools
    | where {|tool| (which $tool.cmd | is-empty)}
    | each {|tool|
        if ($tool."in-args"? | is-empty) {
            ^cargo install $tool.cmd
        } else {
            ^cargo install ...$tool."in-args"
        }
    }

# ── uv tool installs ──────────────────────────────────────────────────────────

{{ range .uv -}}
{{- if kindIs "string" . }}
uv tool install {{ . }}
{{- else }}
if (which {{ .which }} | is-empty) { uv tool install {{ .name }} }
{{- end }}
{{ end -}}

# ── go installs ───────────────────────────────────────────────────────────────

let go_tools = [
    {{- range .go }}
    {cmd: "{{ .cmd }}", args: {{ .args | toJson }}}
    {{- end }}
]

$go_tools
    | where {|tool| (which $tool.cmd | is-empty)}
    | each {|tool| ^go install ...$tool.args}

# ── heads up ──────────────────────────────────────────────────────────────────

{{ if eq .chezmoi.osRelease.id "opensuse-tumbleweed" "opensuse-leap" "opensuse" -}}
print ""
print "NOTE: swww is installed but your configs reference 'awww-daemon'."
print "      The swww binary is 'swww-daemon' — update your systemd service and awww-daemon.service if needed."
{{ end -}}

print "essential package check: done!"
