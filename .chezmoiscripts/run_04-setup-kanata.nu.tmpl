#!/usr/bin/env nu

# ── kanata ─────────────────────────────────────────────────────────────────────

print "installing kanata.service..."
sudo mkdir -p /etc/systemd/system
chezmoi execute-template (open $"{{ .chezmoi.sourceDir }}/.chezmoitemplates/kanata.service") | sudo tee /etc/systemd/system/kanata.service | ignore

{{ if eq .chezmoi.osRelease.id "opensuse-tumbleweed" "opensuse-leap" "opensuse" -}}
# symlink cargo-installed kanata into /usr/local/bin so the sandboxed service can reach it
let cargo_bin = $"($env.HOME)/.cargo/bin/kanata"
if ($cargo_bin | path exists) {
    sudo ln -sf $cargo_bin /usr/local/bin/kanata
} else {
    print "warning: kanata not found in ~/.cargo/bin, skipping symlink"
}
{{ end -}}

sudo systemctl daemon-reload

# ── kanata user / system setup ──────────────────────────────────────────────

# ensure uinput group exists (may not be present by default)
if (^getent group uinput | complete).exit_code != 0 {
    sudo groupadd uinput
} else { print "ugroup exists, skipping creation"}

if (^id kanata-user | complete).exit_code != 0 {
    print "setting up kanata user..."


    # dedicated system user with no login shell
    sudo useradd -r -s /sbin/nologin kanata-user
    sudo usermod -aG input,uinput kanata-user

    # load uinput now and persist across reboots
    "uinput" | sudo tee /etc/modules-load.d/uinput.conf
    sudo modprobe uinput

    # allow uinput group to access /dev/uinput
    'KERNEL=="uinput", GROUP="uinput", MODE="0660"' | sudo tee /etc/udev/rules.d/99-uinput.rules
    sudo udevadm control --reload-rules
    sudo udevadm trigger

    sudo systemctl enable --now kanata.service
} else { print "kanata-user already exists, skipping user setup" }

print "done"
